name: Backend CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: backend
      run: npm ci

    - name: Build
      working-directory: backend
      run: npm run build

    - name: Deploy to Railway
      uses: railwayapp/action@v1.0.0
      with:
        service: backend
        token: ${{ secrets.RAILWAY_TOKEN }}
        environment: production
        variables: |
          NODE_ENV=production
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          CORS_ORIGIN=https://easycraft.vercel.app
